<!DOCTYPE html>

<title> Algo </title>

<h1> Algorithmic Composer </h1>

<body>
    <div class="footer">Shayna Kaushal for Online Algorithmic Music 
        | UChicago | Spring 2023</div>
  </body>

<style>
    h1 {
      text-align: center;
      background-color: rgb(255, 208, 249);
      font-family: Arial, sans-serif;
      font-size: 18pt;
    }
  
    body { 
        background-color: black; 
        text-align: left;
    }
  
    .footer{ 
      position: fixed;     
      text-align: center;    
      bottom: 0px; 
      width: 100%;
      background-color: rgb(61, 60, 60);
      font-family: Arial, sans-serif;
    }  

    canvas { display: block; }
    body { margin:0; }

</style>

<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.js"></script>
<script src="https://tonejs.github.io/build/Tone.js"></script>

<script>

balls = []
synths = []

cols = 21
diam = 20

click_flag = -1

cur_lst_ctr = 0
draw_lst_ctr = 0

big_lst = {}

const bright_color_lst = [
    'rgb(255,0,0)',
    'rgb(255,145,0)',
    'rgb(255,252,0)',
    'rgb(0,255,0)',
    'rgb(0,255,255)',
    'rgb(0,128,255)',
    'rgb(153,51,255)',
    'rgb(255,0,255)'
]

var b_col_idx = 0

var speedy_slider
var bouncy_slider



class Lst{
    constructor(ball_color, low_ball_color, ddiam, speedy, bouncy) {
        this.balls = []
        this.synths = []
        this.bounce = bouncy
        this.speed = speedy
        this.notes = [
            'C#3', 'D#3', 'E3', 'F#3', 'G#3', 'A3', 'B3',
            'C#4', 'D#4', 'E4', 'F#4', 'G#4', 'A4', 'B4',
            'C#5', 'D#5', 'E5', 'F#5', 'G#5', 'A5', 'B5',
        ]
        this.start_cnt = 0
        this.color = color(ball_color)
        this.low_color = color(low_ball_color)
        this.ddiam = ddiam
    }


    createBall (i, cols, diam) {
        const offsetX = innerWidth / 2 - ((cols * diam) / 2)
        const x = i * diam + offsetX
        const y = innerHeight / 2
        const r = diam / 2
        return { x, y, r }
    }


    get_synth(synth_choice){
        switch(synth_choice){
            case 'AMSynth':
                return new Tone.AMSynth().toDestination()
                break;
            case 'FMSynth':
                return new Tone.FMSynth().toDestination()
                break;
            case 'MonoSynth':
                return new Tone.MonoSynth().toDestination()
                break;
            default:
                return new Tone.Synth().toDestination()
        }
    }


    setup(cols, diam, synth_choice){
        for (let i = 0; i < cols; i++) {
            const b = this.createBall(i, cols, diam)
            this.balls.push(b)
            var s = this.get_synth(synth_choice)
            this.synths.push(s)
        }
    }


    draw(){
        const range = height/4
        const offset = height/2 - this.ddiam/2
        const ground = height*0.75

        this.balls.forEach((b, i) => {
            const scaler = i * this.bounce + this.speed
            b.y = Math.sin(this.start_cnt * scaler) * range + offset
            if (b.y + this.ddiam/2 >= ground - 1) {
                fill(this.low_color)
                const n = this.notes[i] 
                const s = this.synths[i]
                s.triggerAttackRelease(n, '8n', Tone.now())
            } else {
                fill(this.color)
            }
            noStroke()
            circle(b.x, b.y, this.ddiam)
            stroke(250)
        })
        this.start_cnt += 1
    }
}



function setup () {
    createCanvas(innerWidth, innerHeight)

    // Position values
    const all_x = 20
    const start_y = 60
    const in_y = 100
    const sel_x = 250
    const sel_y = 100
    const slabel_x = 360
    const slabel_y = 90
    const blabel_x = 530
    const blabel_y = 90
    const balllst_y = 140
    const new_button_y = 160

    
    // Start button
    var start_b = createButton('Start');
    start_b.position(all_x, start_y);
    start_b.mousePressed(() => {
        click_flag = click_flag * -1
        Tone.start()
    });
    

    // Radius input
    input = createInput();
    input.position(all_x, in_y);
    input.attribute('placeholder', 'Enter radius');
    var ddiam = 10;
    in_button = createButton('Submit');
    in_button.position(input.x + input.width, in_y);
    in_button.mousePressed(() => {
        var inp = input.value();
        ddiam = inp * 2;
    });


    // Synth selector
    var synth_sel = createSelect();
    synth_sel.position(sel_x, sel_y);
    synth_sel.option('Synth');
    synth_sel.option('AMSynth');
    synth_sel.option('FMSynth');
    synth_sel.option('MonoSynth');
    synth_sel.selected('Synth');
    

    // Sliders
    speedy_label = createDiv('Speedy    ');
    speedy_label.style('font-size', '10px');
    speedy_label.style('color', color(150));
    speedy_label.position(slabel_x, slabel_y);  
    speedy_slider = createSlider(1, 100, 5);
    speedy_slider.parent(speedy_label);
    speedy_slider.style('width', '90%');
    
    bouncy_label = createDiv('Bouncy   ');
    bouncy_label.style('font-size', '10px');
    bouncy_label.style('color', color(150));
    bouncy_label.position(blabel_x, blabel_y);  
    bouncy_slider = createSlider(1, 10, 5);
    bouncy_slider.parent(bouncy_label);
    bouncy_slider.style('width', '90%');


    // New list button
    var remove_lst = []
    var ball_lst_b = createButton('Add!');
    ball_lst_b.position(all_x, balllst_y);
    ball_lst_b.mousePressed(() => {
        var ball_color = color(bright_color_lst[b_col_idx%8])
        var low_ball_color = color(bright_color_lst[b_col_idx%8])
        low_ball_color.setAlpha(70)
        b_col_idx++

        var speedy = speedy_slider.value() / 1000
        var bouncy = bouncy_slider.value() / 10000
        var synth_choice = synth_sel.value()

        let new_lst = new Lst(ball_color, low_ball_color, ddiam, speedy, bouncy)
        new_lst.setup(cols, diam, synth_choice)

        var cur_i = 0
        if (Object.keys(big_lst).length > 0){
            cur_i = Object.keys(big_lst).length
        }

        big_lst[cur_i] = new_lst

        var new_button = createButton('List ' + (cur_i+1))
        var cur_y = (new_button_y + cur_i*20)

        if (remove_lst.length > 0){
            cur_i = remove_lst[0]
            remove_lst.splice(0, 1)
        }

        console.log('out rem:', remove_lst)
        console.log('out big:', big_lst)

        new_button.position(all_x, cur_y);
        new_button.mousePressed(() => {
            if (big_lst.length == 1){
                big_lst = {}
                remove_lst = []
                console.log('if rem:', remove_lst)
                console.log('if big:', big_lst)
            }
            else{
                delete big_lst[cur_i]
                remove_lst.push(cur_i)
                remove_lst.sort()
                console.log('else rem:', remove_lst)
                console.log('else big:', big_lst)
                console.log('else curi:', cur_i)
            }
            console.log('rem:', remove_lst)
            console.log('big:', big_lst)

            new_button.remove()
        })
    });
}



function draw () {
    const ground = height*0.75
    if (click_flag == 1){
        background(0)
        
        line(width * 0.1, ground, width * 0.9, ground)
        stroke(250)

        var tmp_vals = Object.entries(big_lst)
        for (const [key, value] of tmp_vals) {
            value.draw(diam)
        }
    }
}

</script>