<!DOCTYPE html>

<title> Algo </title>

<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.js"></script>
<script src="https://tonejs.github.io/build/Tone.js"></script>


<!-- <input type="range" min="0.0001" max="0.01" value="50" class="slider" id="bouncy">
<p>Value: <span id="sliderValue1"></span></p>

<input type="range" min="0.0001" max="0.1" value="0.1" class="slider" id="speedy">
<p>Value: <span id="sliderValue2"></span></p> -->

<!-- <input type="number" id="radius" placeholder="Enter desired radius">
<button onclick="showInputValue()">Submit</button> -->


<style>

/* .slider {
    appearance: none;
    position: relative;
    width: 30%;
    height: 10px;
    border-radius: 5px;
    background: #ccc;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #4CAF50;
    cursor: pointer;
} */

/* input[type="number"] {
    width: 200px;
    padding: 10px;
    font-size: 16px;
}

button {
    padding: 10px 20px;
    font-size: 16px;
} */


</style>


<script>

balls = []
synths = []

cols = 21
diam = 20

// make sure to change spacing depending on the diam - should be furhter for smaller diam

click_flag = -1

cur_lst_ctr = 0
draw_lst_ctr = 0

big_lst = []

const bright_color_lst = ['#FF0000', '#FFC000', '#FFFC00', '#00FF00', '#00FFFF', '#0080FF', '#9933FF', '#FF00FF', '#FF007F']
var b_col_idx = 0


var speedy_slider
var bouncy_slider

class Lst{
    // constructor(b, s) {
    constructor(ball_color, ddiam, speedy, bouncy) {
        this.balls = []
        this.synths = []
        this.bounce = bouncy //0.0001 //0.001
        this.speed = speedy //0.01 //0.1
        this.notes = [
            'C#3', 'D#3', 'E3', 'F#3', 'G#3', 'A3', 'B3',
            'C#4', 'D#4', 'E4', 'F#4', 'G#4', 'A4', 'B4',
            'C#5', 'D#5', 'E5', 'F#5', 'G#5', 'A5', 'B5',
        ]
        this.start_cnt = 0
        this.color = color(ball_color)
        this.ddiam = ddiam
        //TODO   
    }

    createBall (i, cols, diam) {
        // console.log('createball')

        const offsetX = innerWidth / 2 - ((cols * diam) / 2)
        const x = i * diam + offsetX
        const y = innerHeight / 2
        const r = diam / 2
        return { x, y, r }
    }

    get_synth(synth_choice){
        switch(synth_choice){
            case 'AMSynth':
                return new Tone.AMSynth().toDestination()
                break;
            case 'FMSynth':
                return new Tone.FMSynth().toDestination()
                break;
            case 'MonoSynth':
                return new Tone.MonoSynth().toDestination()
                break;
            default:
                return new Tone.Synth().toDestination()
        }
    }

    setup(cols, diam, synth_choice){
        for (let i = 0; i < cols; i++) {
            const b = this.createBall(i, cols, diam)
            this.balls.push(b)
            var s = this.get_synth(synth_choice)

            // const s = new Tone.Synth().toDestination()
            // const s = new Tone.AMSynth().toDestination()
            // const s = new Tone.FMSynth().toDestination()
            // const s = new Tone.MonoSynth().toDestination()

            this.synths.push(s)
        }
    }

    draw(){
        const range = height/4
        const offset = height/2 
        const ground = height*0.75

        this.balls.forEach((b, i) => {
            const scaler = i * this.bounce + this.speed
            b.y = Math.sin(this.start_cnt * scaler) * range + offset - this.ddiam/2
            if (b.y + this.ddiam/2 >= ground - 1) {
                // fill(this.color[0], this.color[1], this.color[2])
                // fill(color())
                // fill()
                fill('black')
                
                const n = this.notes[i] 
                const s = this.synths[i]
                s.triggerAttackRelease(n, '8n', Tone.now())
            } else {
                fill(this.color)
                // fill(134, 123, 220)
            }
            // console.log('lst draw this.ddiam: ' + this.ddiam)
            circle(b.x, b.y, this.ddiam)
        })
        this.start_cnt += 1
    }
}


function setup () {
    createCanvas(innerWidth, innerHeight)
    // each time new button is pressed, make new ball lst!!!
    
    // Start button
    var start_b = createButton('Start!');
    start_b.position(20, 150);
    start_b.mousePressed(() => {
        click_flag = click_flag * -1
        Tone.start()
    });

    input = createInput();
    input.position(100, 35);
    input.attribute('placeholder', 'Enter desired radius in px (default=10)');

    var ddiam = 10;

    var synth_sel = createSelect();
    synth_sel.position(20, 180);
    synth_sel.option('Synth');
    synth_sel.option('AMSynth');
    synth_sel.option('FMSynth');
    synth_sel.option('MonoSynth');
    synth_sel.selected('Synth');
    // synth_sel.changed(mySelectEvent);

    in_button = createButton('Submit');
    in_button.position(input.x + input.width, 35);
    in_button.mousePressed(() => {
        var inp = input.value();
        ddiam = inp * 2;
    });

    speedy_slider = createSlider(1, 10);
    bouncy_slider = createSlider(1, 10);
    speedy_slider.position(20, 100);
    bouncy_slider.position(20, 120);
    speedy_slider.style('width', '30%');
    bouncy_slider.style('width', '30%');

    // New list button
    var ball_lst_b = createButton('new ball lst!');
    ball_lst_b.position(20, 200);
    ball_lst_b.mousePressed(() => {

        // var ball_color = this.getColor()
        var ball_color = bright_color_lst[b_col_idx%9]

        b_col_idx++

        var speedy = speedy_slider.value() /1000
        var bouncy = bouncy_slider.value() /1000
        console.log('sending s b: ' + speedy, bouncy)

        var synth_choice = synth_sel.value()

        let new_lst = new Lst(ball_color, ddiam, speedy, bouncy)
        new_lst.setup(cols, diam, synth_choice)

        big_lst.push(new_lst)
    });
    // background(180)

}


function draw () {
    const ground = height*0.75
    if (click_flag == 1){
        background(180)
        line(width * 0.1, ground, width * 0.9, ground)
        big_lst.forEach(cur_lst => {
            cur_lst.draw(diam)
        })
    }
}

</script>